const viewBtn = document.getElementById("viewBtn");
const welcome = document.getElementById("welcome");
const stickman = document.getElementById("stickman");
const armRight = document.getElementById("armRight");
const bomb = document.getElementById("bomb");
const explosion = document.getElementById("explosion");
const message = document.getElementById("message");
const body = document.body;

const GRAVITY = 1800;
const THROW_TIME = 1.05;
const TYPING_SPEED = 40;

// H√†m ƒë√°nh ch·ªØ
function typeWriter(text, speed = TYPING_SPEED, append = false) {
  return new Promise((resolve) => {
    message.classList.remove("hidden");
    message.style.opacity = 1;
    if (!append) message.innerHTML = "";
    let i = 0;
    const timer = setInterval(() => {
      const ch = text[i];
      message.innerHTML += ch === "\n" ? "<br>" : ch;
      i++;
      if (i >= text.length) {
        clearInterval(timer);
        resolve();
      }
    }, speed);
  });
}

// N√©m bom parabol
function throwBombParabola(start, target, totalTimeSec) {
  const startTime = performance.now();
  const t = totalTimeSec;
  const dx = target.x - start.x;
  const dy = target.y - start.y;
  const vx = dx / t;
  const vy = (dy - 0.5 * GRAVITY * t * t) / t;

  return new Promise((resolve) => {
    function frame(now) {
      const elapsed = (now - startTime) / 1000;
      if (elapsed >= t) {
        bomb.style.left = `${target.x}px`;
        bomb.style.top = `${target.y}px`;
        resolve();
        return;
      }
      const curX = start.x + vx * elapsed;
      const curY = start.y + vy * elapsed + 0.5 * GRAVITY * elapsed * elapsed;
      bomb.style.left = `${curX}px`;
      bomb.style.top = `${curY}px`;
      bomb.style.transform = `translate(-50%,-50%) rotate(${elapsed * 720}deg)`;
      requestAnimationFrame(frame);
    }
    requestAnimationFrame(frame);
  });
}

// Hoa bay
function spawnFlowers(cx, cy, count = 20) {
  for (let i = 0; i < count; i++) {
    const el = document.createElement("div");
    el.innerText = Math.random() < 0.5 ? "üå∏" : "üíÆ";
    el.style.position = "absolute";
    el.style.left = `${cx}px`;
    el.style.top = `${cy}px`;
    el.style.zIndex = 120;
    el.style.pointerEvents = "none";
    el.style.fontSize = `${18 + Math.random() * 8}px`;
    document.body.appendChild(el);

    const angle = Math.random() * Math.PI * 2;
    const dist = 90 + Math.random() * 160;
    const tx = cx + Math.cos(angle) * dist;
    const ty = cy + Math.sin(angle) * dist - 40;

    el.animate(
      [
        { transform: "translate(-50%,-50%) scale(0.2)", opacity: 1 },
        {
          transform: `translate(${tx - cx}px, ${ty - cy}px) scale(1) rotate(${Math.random() * 360}deg)`,
          opacity: 1,
        },
        {
          transform: `translate(${tx - cx}px, ${ty - cy - 30}px) scale(0.6) rotate(${Math.random() * 720}deg)`,
          opacity: 0,
        },
      ],
      { duration: 1500 + Math.random() * 1000, easing: "cubic-bezier(.2,.9,.3,1)", fill: "forwards" }
    );
    setTimeout(() => el.remove(), 2500 + Math.random() * 700);
  }
}

// Bom lƒÉn
function rollBomb(startX, endX, y, duration = 2000) {
  return new Promise((resolve) => {
    bomb.classList.remove("hidden");
    bomb.style.opacity = 1;
    bomb.style.top = `${y}px`;
    bomb.animate(
      [
        { left: `${startX}px`, transform: "translate(-50%, -50%) rotate(0deg)" },
        { left: `${endX}px`, transform: "translate(-50%, -50%) rotate(720deg)" },
      ],
      { duration, easing: "ease-in-out", fill: "forwards" }
    );
    setTimeout(resolve, duration);
  });
}

// Hi·ªáu ·ª©ng n·ªï
function explodeAt(x, y) {
  return new Promise((resolve) => {
    bomb.style.opacity = 0;
    explosion.classList.remove("hidden");
    explosion.style.left = `${x}px`;
    explosion.style.top = `${y}px`;
    explosion.style.transform = `translate(-50%,-50%) scale(1.6)`;
    explosion.style.opacity = 1;
    spawnFlowers(x, y, 30);

    body.animate(
      [
        { transform: "translate(0,0)" },
        { transform: "translate(10px,-10px)" },
        { transform: "translate(-10px,10px)" },
        { transform: "translate(0,0)" },
      ],
      { duration: 600 }
    );

    setTimeout(() => {
      explosion.style.opacity = 0;
      explosion.style.transform = `translate(-50%,-50%) scale(3)`;
      resolve();
    }, 900);
  });
}

// Hi·ªáu ·ª©ng chuy·ªÉn c·∫£nh
function transitionToScene2() {
  return new Promise((resolve) => {
    const plane = document.createElement("div");
    plane.innerText = "üöÄ";
    plane.style.position = "fixed";
    plane.style.left = "-100px";
    plane.style.bottom = "40px";
    plane.style.fontSize = "60px";
    plane.style.zIndex = 250;
    plane.style.filter = "drop-shadow(0 0 10px white)";
    document.body.appendChild(plane);

    const overlay = document.createElement("div");
    overlay.style.position = "fixed";
    overlay.style.inset = 0;
    overlay.style.zIndex = 200;
    overlay.style.background = "#fff";
    overlay.style.opacity = 0;
    document.body.appendChild(overlay);

    plane.animate(
      [
        { transform: "translate(0,0) rotate(15deg)", opacity: 1 },
        { transform: "translate(400px,-150px) rotate(5deg)", opacity: 1 },
        { transform: `translate(${window.innerWidth + 200}px,-400px) rotate(-10deg)`, opacity: 0.8 },
      ],
      { duration: 2500, easing: "ease-in-out", fill: "forwards" }
    );

    overlay.animate([{ opacity: 0 }, { opacity: 1 }, { opacity: 0 }], {
      duration: 2600,
      fill: "forwards",
      easing: "ease-in-out",
    });

    setTimeout(() => {
      body.animate(
        [
          { background: "linear-gradient(135deg,#ffd6e7,#fff0f5)" },
          { background: "linear-gradient(135deg,#ffb8d2,#ffe0e7)" },
          { background: "linear-gradient(135deg,#fbc2eb,#a6c1ee)" },
        ],
        { duration: 3000, fill: "forwards", easing: "ease-in-out" }
      );
      message.innerHTML = "";
    }, 1300);

    setTimeout(() => {
      plane.remove();
      overlay.remove();
      resolve();
    }, 2700);
  });
}

// üé¨ K·ªãch b·∫£n ch√≠nh
viewBtn.addEventListener("click", async () => {
  // Giai ƒëo·∫°n 1 ‚Äì n·ªÅn ƒë·ªè h·ªìng nƒÉng ƒë·ªông
  body.style.background = "linear-gradient(135deg,#ffb6c1,#ff7f7f)";
  welcome.style.opacity = 0;
  setTimeout(() => (welcome.style.display = "none"), 500);

  stickman.classList.remove("hidden");
  bomb.classList.remove("hidden");

  const rect = stickman.getBoundingClientRect();
  const startX = rect.left + rect.width * 0.78;
  const startY = rect.top + rect.height * 0.45;
  bomb.style.left = `${startX}px`;
  bomb.style.top = `${startY}px`;
  bomb.style.opacity = 1;

  armRight.animate([{ transform: "rotate(-30deg)" }, { transform: "rotate(-80deg)" }], {
    duration: 220,
    easing: "ease-out",
    fill: "forwards",
  });
  await new Promise((r) => setTimeout(r, 180));

  const vw = window.innerWidth;
  const vh = window.innerHeight;
  const target = { x: vw * 0.52, y: vh * 0.42 };

  armRight.animate([{ transform: "rotate(-80deg)" }, { transform: "rotate(10deg)" }], {
    duration: 480,
    easing: "cubic-bezier(.2,.9,.3,1)",
    fill: "forwards",
    delay: 120,
  });

  await throwBombParabola({ x: startX, y: startY }, target, THROW_TIME);
  await explodeAt(target.x, target.y);

  stickman.style.opacity = 0;
  setTimeout(() => stickman.classList.add("hidden"), 400);

  await new Promise((r) => setTimeout(r, 500));

  // -------- TAB 1 --------
  await typeWriter(
    "Ch√†o con g√† tduong, c√°i n√†y ƒë∆∞·ª£c nghƒ© v√† b·∫Øt tay v√†o l√†m h∆°n th√°ng, nma c≈©ng l√† tr√¨nh 1 th·∫±ng nƒÉm hai v√† g√† m·ªù n√™n h∆°i s∆° s√†i, c√≥ g√¨ th√¥ng c·∫£m cho b·∫°n üòÄüòÄüòÄüòÄ",
    40,
    false
  );

  // Gi·ªØ l·∫°i n·ªôi dung v√†i gi√¢y tr∆∞·ªõc khi qua tab 2
  await new Promise((r) => setTimeout(r, 2500));

  // X√≥a n·ªôi dung tab 1 (chuy·ªÉn sang tab 2)
  message.innerHTML = "";

  // Giai ƒëo·∫°n 2 ‚Äì n·ªÅn h·ªìng pastel nh·∫π (ƒë·∫≠m h∆°n ƒë·ªÉ ch·ªØ n·ªïi r√µ)
  body.animate(
    [
      { background: "linear-gradient(135deg, #f5c6ec, #ffe4f2)" },
      { background: "linear-gradient(135deg, #e8aaff, #ffd6eb)" },
    ],
    { duration: 2000, fill: "forwards" }
  );

  // -------- TAB 2 --------
  await new Promise((r) => setTimeout(r, 1500));
  await typeWriter(
    "ƒê·∫ßu ti√™n th√¨ T√¥i ch√∫c b·∫°n 20/10 vui v·∫ª v√† l√∫c n√†o c≈©ng xinh nh∆∞ nh·ªØng b√≥ hoa nh√© =))))))üòÄüòÄüò∂‚Äçüå´Ô∏èüò∂‚Äçüå´Ô∏è",
    40,
    false
  );

  await new Promise((r) => setTimeout(r, 2000));
  await typeWriter("\nH·ªçc √≠t th√¥i dcmmm =)))", 40, true);
  await new Promise((r) => setTimeout(r, 2500));
  await typeWriter("\nTi·∫øp n√†o con g√† =)))))", 50, true);

  await new Promise((r) => setTimeout(r, 1000));
  await transitionToScene2();

  // C√°c ƒëo·∫°n sau (tab 3...) gi·ªØ nguy√™n nh∆∞ c≈©
  const start2X = -100;
  const midY = window.innerHeight * 0.65;
  const midX = window.innerWidth / 2;

  await rollBomb(start2X, midX, midY, 2500);
  await explodeAt(midX, midY);

  // Giai ƒëo·∫°n 3 ‚Äì n·ªÅn t√≠m h·ªìng m·ªông m∆°
  body.animate(
    [
      { background: "linear-gradient(135deg,#ffdef2,#ffc9e7)" },
      { background: "linear-gradient(135deg,#fbc2eb,#a6c1ee)" },
      { background: "linear-gradient(135deg,#dcb0ed,#99c2ff)" },
    ],
    { duration: 4000, fill: "forwards", easing: "ease-in-out" }
  );

  await new Promise((r) => setTimeout(r, 2000));
  await typeWriter("Tab n√†y b·∫°n cop gpt nma v·∫´n th·∫≠t l√≤ng nha =))), t·∫°i b·ªã b√≠ √Ω t∆∞·ªüng √°", 40, false);
  await new Promise((r) => setTimeout(r, 2000));
  await typeWriter("\nCh√∫c b·∫°n m·ªôt ng√†y 20/10 th·∫≠t ƒë·∫∑c bi·ªát - ƒë∆∞·ª£c nh·∫≠n nhi·ªÅu l·ªùi ch√∫c, hoa v√† c·∫£ nh·ªØng ƒëi·ªÅu b·∫•t ng·ªù d·ªÖ th∆∞∆°ng n·ªØa üòÑ", 40, false);
  await new Promise((r) => setTimeout(r, 2000));
  await typeWriter("\nHy v·ªçng b·∫°n lu√¥n gi·ªØ ƒë∆∞·ª£c n·ª• c∆∞·ªùi t∆∞∆°i, tinh th·∫ßn l·∫°c quan v√† ni·ªÅm vui trong h·ªçc t·∫≠p c≈©ng nh∆∞ cu·ªôc s·ªëng.", 40, false);
  await new Promise((r) => setTimeout(r, 2000));
  await typeWriter("\nN√≥i chung l√† ch√∫c m·ªçi ƒëi·ªÅu t·ªët ƒë·∫πp nh·∫•t s·∫Ω ƒë·∫øn v·ªõi b·∫°n nha! üíê‚ú®", 40, false);
  await new Promise((r) => setTimeout(r, 2500));
  await typeWriter("\nC√≥ th·ªÉ ƒë·∫øn ƒë√¢y th√¥i ƒë∆∞·ª£c r·ªìi, h∆°i s∆° s√†i nh∆∞ng m√† c√≥ th√†nh √Ω =)))", 40, true);
  await new Promise((r) => setTimeout(r, 2000));
  await typeWriter("\nüò§üò†√Ä dcmm m h·∫πn ch√°n ch√™ ƒëi ƒÉn r c√≤n ch∆∞a ƒëi ƒë√¢u ƒë√≥, nma thoi t·∫°m th·ªùi b√¢y gi·ªù ch·∫Øc kh√¥ng c·∫ßn n·ªØa =)))ü§¶‚Äç‚ôÇÔ∏èü§¶‚Äç‚ôÇÔ∏èü§¶‚Äç‚ôÇÔ∏è", 40, false);

  // üé¨ K·∫øt th√∫c l√£ng m·∫°n (gi·ªØ nguy√™n ƒëo·∫°n k·∫øt)
  await new Promise((r) => setTimeout(r, 3500));
  const overlay = document.createElement("div");
  overlay.style.position = "fixed";
  overlay.style.inset = 0;
  overlay.style.background = "linear-gradient(135deg,#f8e0f7,#f9c5d1,#f1d1f1)";
  overlay.style.zIndex = 400;
  overlay.style.display = "flex";
  overlay.style.flexDirection = "column";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.fontSize = "2em";
  overlay.style.color = "#a3006b";
  overlay.style.textAlign = "center";
  overlay.style.opacity = 0;
  overlay.style.transition = "opacity 1.5s ease";
  overlay.style.backdropFilter = "blur(8px)";
  overlay.innerHTML = `
    <div>H·∫øt r·ªìi con g√† </div>
    <div style="font-size:1.4rem;margin-top:12px;">C·∫£m ∆°n v√¨ ƒë√£ xem ƒë·∫øn cu·ªëi nh√°</div>
    <div style="font-size:1.2rem;margin-top:8px;">Tduong is a chickenüêîüêîüêî </div>
    <button id="retryBtn" style="
      margin-top:28px;
      background: linear-gradient(90deg,#ff9ad6,#ff5fb1);
      color:#fff;
      border:none;
      padding:10px 28px;
      border-radius:30px;
      font-size:1rem;
      cursor:pointer;
      box-shadow:0 0 20px rgba(255,100,200,0.3);
      transition:transform 0.2s ease;
    ">üîÅ c√≥ mu·ªën xem l·∫°i th√¨ click v√†o ƒë√¢y =))</button>
  `;
  document.body.appendChild(overlay);

  overlay.offsetHeight;
  overlay.style.opacity = 1;

  // Hoa bay nh·∫π n·ªÅn k·∫øt th√∫c
  setInterval(() => {
    spawnFlowers(Math.random() * window.innerWidth, Math.random() * window.innerHeight, 1);
  }, 900);

  document.getElementById("retryBtn").addEventListener("click", () => {
    overlay.style.opacity = 0;
    setTimeout(() => {
      overlay.remove();
      location.reload();
    }, 800);
  });
});
